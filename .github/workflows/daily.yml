name: Daily Research & Tech Digest

on:
  schedule:
    - cron: "0 1 * * *"   # UTC 01:00 (UTC+8 09:00) - æ—©ä¸Š9ç‚¹
    - cron: "0 13 * * *"  # UTC 13:00 (UTC+8 21:00) - æ™šä¸Š9ç‚¹
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install

      - name: Run daily digest
        env:
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        timeout-minutes: 15  # å¢åŠ åˆ°15åˆ†é’Ÿï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæ—¶é—´å®ŒæˆRSSæŠ“å–ã€å†…å®¹æŠ“å–å’ŒLLMç”Ÿæˆ
        run: node scripts/run.js

      - name: Commit daily digest
        id: commit
        run: |
          git config user.name "news-bot"
          git config user.email "bot@users.noreply.github.com"
          
          # è·å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹
          git fetch origin main
          
          # å°è¯•åˆå¹¶è¿œç¨‹æ›´æ”¹ï¼ˆä½¿ç”¨ rebase ä¿æŒå†å²å¹²å‡€ï¼‰
          git pull origin main --rebase --no-edit || {
            echo "Rebase failed, trying merge instead..."
            git pull origin main --no-edit || {
              echo "Merge also failed, resetting to remote..."
              git fetch origin main
              git reset --hard origin/main
            }
          }
          
          # åˆ¤æ–­æ˜¯ä¸Šåˆè¿˜æ˜¯ä¸‹åˆï¼ˆUTC+8 æ—¶åŒºï¼‰
          CURRENT_HOUR=$(TZ='Asia/Shanghai' date +%H)
          if [ "$CURRENT_HOUR" -lt 12 ]; then
            TIME_SLOT="morning"
            TIME_LABEL="ä¸Šåˆ"
          else
            TIME_SLOT="evening"
            TIME_LABEL="æ™šä¸Š"
          fi
          
          # ä¿å­˜åˆ°è¾“å‡ºå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "time_slot=${TIME_SLOT}" >> $GITHUB_OUTPUT
          echo "time_label=${TIME_LABEL}" >> $GITHUB_OUTPUT
          
          # æ·»åŠ å¹¶æäº¤æ–°çš„æ—¥æŠ¥æ–‡ä»¶
          DATE=$(date +'%Y-%m-%d')
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          
          git add daily/
          git commit -m "chore: daily research & tech digest ${DATE} ${TIME_LABEL}" || echo "No changes to commit"
          
          # æ¨é€æ›´æ”¹
          git push origin main
      
      - name: Create GitHub Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ä»ä¸Šä¸€æ­¥è·å–å˜é‡
          TIME_SLOT="${{ steps.commit.outputs.time_slot }}"
          TIME_LABEL="${{ steps.commit.outputs.time_label }}"
          DATE="${{ steps.commit.outputs.date }}"
          
          # ç”Ÿæˆæ–‡ä»¶å
          FILENAME="daily/${DATE}-${TIME_SLOT}.md"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$FILENAME" ]; then
            echo "âš ï¸  File $FILENAME not found, skipping issue creation"
            exit 0
          fi
          
          # è¯»å– Markdown æ–‡ä»¶å†…å®¹
          MD_CONTENT=$(cat "$FILENAME")
          
          # åˆ›å»º Issue æ ‡é¢˜
          ISSUE_TITLE="ğŸ“° ç§‘ç ” & æŠ€æœ¯çƒ­ç‚¹æ—¥æŠ¥ - ${DATE} ${TIME_LABEL}"
          
          # å®šä¹‰éœ€è¦çš„æ ‡ç­¾åŠå…¶é…ç½®
          # æ ¼å¼: "æ ‡ç­¾å|é¢œè‰²|æè¿°"
          LABEL_CONFIGS=(
            "daily-digest|0E8A16|Daily research & tech digest"
            "automated|7057FF|Automated by GitHub Actions"
          )
          
          # è‡ªåŠ¨åˆ›å»ºæ ‡ç­¾ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          echo "ğŸ·ï¸  Checking and creating labels..."
          for LABEL_CONFIG in "${LABEL_CONFIGS[@]}"; do
            # è§£æé…ç½®
            IFS='|' read -r LABEL COLOR DESCRIPTION <<< "$LABEL_CONFIG"
            
            # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨ï¼ˆä½¿ç”¨æ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
            LABEL_EXISTS=$(gh label list --json name --jq ".[] | select(.name==\"${LABEL}\") | .name" 2>/dev/null | grep -q "^${LABEL}$" && echo "yes" || echo "no")
            
            if [ "$LABEL_EXISTS" = "no" ]; then
              echo "   ğŸ“ Creating label: ${LABEL}"
              # åˆ›å»ºæ ‡ç­¾
              gh label create "${LABEL}" \
                --color "${COLOR}" \
                --description "${DESCRIPTION}" 2>&1 || {
                  echo "   âš ï¸  Failed to create label: ${LABEL}, but continuing..."
                }
            else
              echo "   âœ“ Label already exists: ${LABEL}"
            fi
          done
          
          # ä½¿ç”¨ GitHub CLI åˆ›å»º Issue
          echo "ğŸ“ Creating GitHub Issue: $ISSUE_TITLE"
          
          # åˆ›å»º Issueï¼ˆå¸¦æ ‡ç­¾ï¼‰
          gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$MD_CONTENT" \
            --label "daily-digest" \
            --label "automated" 2>&1 || {
              echo "âŒ Issue creation failed, but continuing workflow"
              exit 0  # ä¸ä¸­æ–­å·¥ä½œæµ
            }
          
          echo "âœ… Issue created successfully"

